---
import Layout from '../../layouts/Layout.astro';
import CodeBlock from '../../components/CodeBlock.astro';

const basicScript = `// 現在表示されている画像URLを取得
const urls = Array.from(document.querySelectorAll('img[src*="pbs.twimg.com"]'))
  .map(img => img.src.replace(/&name=\\w+/, '&name=orig'))
  .filter(url => url.includes('/media/'))
  .filter((v, i, a) => a.indexOf(v) === i);

console.log(urls.join('\\n'));
console.log(\`取得件数: \${urls.length}件\`);`;

const copyToClipboard = `// クリップボードにコピー（エラーハンドリング付き）
const urls = Array.from(document.querySelectorAll('img[src*="pbs.twimg.com"]'))
  .map(img => img.src.replace(/&name=\\w+/, '&name=orig'))
  .filter(url => url.includes('/media/'))
  .filter((v, i, a) => a.indexOf(v) === i);

// クリップボードにコピー（失敗時はコンソールに出力）
navigator.clipboard.writeText(urls.join('\\n'))
  .then(() => {
    alert(\`\${urls.length}件の画像URLをコピーしました！\`);
  })
  .catch(err => {
    console.log('クリップボードへのコピーに失敗しました。以下のURLをコピーしてください：');
    console.log(urls.join('\\n'));
    alert(\`エラーが発生しました。コンソールに出力したURLをコピーしてください。\\n取得件数: \${urls.length}件\`);
  });`;

const bookmarkletCode = `javascript:(function(){const u=Array.from(document.querySelectorAll('img[src*="pbs.twimg.com"]')).map(i=>i.src.replace(/&name=\\w+/,'&name=orig')).filter(url=>url.includes('/media/')).filter((v,i,a)=>a.indexOf(v)===i);navigator.clipboard.writeText(u.join('\\n')).then(()=>alert(u.length+'件の画像URLをコピーしました！'));})();`;

const autoScrollScript = `// 自動スクロールして全画像を読み込む
async function loadAllMedia() {
  let lastHeight = 0;
  let scrollCount = 0;
  const maxScrolls = 50; // 最大スクロール回数
  
  while (scrollCount < maxScrolls) {
    window.scrollTo(0, document.body.scrollHeight);
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const currentHeight = document.body.scrollHeight;
    if (currentHeight === lastHeight) {
      console.log('最後まで読み込みました');
      break;
    }
    lastHeight = currentHeight;
    scrollCount++;
  }
  
  // URL取得
  const urls = Array.from(document.querySelectorAll('img[src*="pbs.twimg.com"]'))
    .map(img => img.src.replace(/&name=\\w+/, '&name=orig'))
    .filter(url => url.includes('/media/'))
    .filter((v, i, a) => a.indexOf(v) === i);
  
  console.log(\`取得件数: \${urls.length}件\`);
  console.log(urls.join('\\n'));
  
  return urls;
}

// 実行
loadAllMedia();`;

const downloadScript = `// 取得したURLから順次ダウンロード（Chrome推奨）
async function downloadImages(urls) {
  for (let i = 0; i < urls.length; i++) {
    const url = urls[i];
    const filename = \`image_\${i + 1}.jpg\`;
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // ブラウザの制限を避けるため少し待機
    await new Promise(resolve => setTimeout(resolve, 500));
  }
}

// 使い方：まず上記のスクリプトでURLを取得後、以下を実行
// const urls = [...]; // 取得したURL配列
// downloadImages(urls);`;
---

<Layout title="X(Twitter)のメディア欄から画像URLを一括取得する方法 - 小技集">
  <main>
    <header class="article-header">
      <a href="/tips" class="back-link">← 小技集一覧</a>
      <h1>X(Twitter)のメディア欄から画像URLを一括取得する方法</h1>
    </header>

    <article class="article-body">
      <p>
        X(Twitter) のメディアタブに表示されている画像のURLを一括で取得する方法。
        開発者ツールのコンソールで実行するだけで、オリジナル画質の画像URLを取得できる。
      </p>

      <h2>メディアタブとは</h2>
      <p>
        ユーザープロフィールページの「メディア」タブをクリックすると、
        そのユーザーが投稿した画像や動画が一覧表示される。
      </p>
      <p>
        <code>https://x.com/username/media</code> の形式でアクセスできる。
      </p>

      <h2>基本：画像URLを取得する</h2>
      
      <h3>1. メディアタブを開く</h3>
      <p>
        対象ユーザーのプロフィールページで「メディア」タブをクリック。
      </p>

      <h3>2. 開発者ツールを開く</h3>
      <p>
        以下のいずれかの方法で開く：
      </p>
      <ul>
        <li>Macの場合: <code>Command + Option + J</code></li>
        <li>Windowsの場合: <code>Ctrl + Shift + J</code></li>
        <li>または右クリック → <strong>検証</strong> → <strong>Console</strong>タブ</li>
      </ul>

      <h3>3. コンソールにスクリプトを入力</h3>
      <p>
        以下のスクリプトをコピーして、コンソールに貼り付けて Enter。
      </p>
      <CodeBlock code={basicScript} language="javascript" />
      <p>
        現在表示されている画像のURLがコンソールに出力される。
        <code>&name=orig</code> が付いているのでオリジナル画質で取得できる。
      </p>

      <h2>クリップボードにコピー</h2>
      <p>
        コンソールの出力をコピーするのが面倒な場合、クリップボードに直接コピーするバージョン：
      </p>
      <CodeBlock code={copyToClipboard} language="javascript" />
      <p>
        実行すると自動的にクリップボードにコピーされて、件数がアラートで表示される。
      </p>
      
      <div class="note-box">
        <strong>⚠️ エラーが出る場合</strong>
        <p>
          「Document is not focused」というエラーが出る場合、以下を試してください：
        </p>
        <ol>
          <li>コンソール以外の場所（ページ本体）を一度クリック</li>
          <li>再度コンソールでスクリプトを実行</li>
        </ol>
        <p>
          または、エラーハンドリング付きのスクリプト（上記）を使えば、
          失敗してもコンソールに出力されるので手動でコピーできる。
        </p>
      </div>

      <h2>ブックマークレット版</h2>
      <p>
        毎回コンソールを開くのが面倒な場合、ブックマークレットにしておくとワンクリックで実行できる。
      </p>

      <h3>登録方法</h3>
      <ol>
        <li>ブックマークバーを表示（<code>Ctrl+Shift+B</code> / <code>Cmd+Shift+B</code>）</li>
        <li>ブックマークバーの上で右クリック → 「ページを追加」</li>
        <li>名前: <code>X画像URL取得</code>（任意）</li>
        <li>URL: 以下のコードをコピー</li>
      </ol>
      <CodeBlock code={bookmarkletCode} language="javascript" />
      <p>
        登録後、メディアタブでブックマークレットをクリックすると、
        画像URLが自動的にクリップボードにコピーされる。
      </p>

      <h2>応用：自動スクロールで全画像を取得</h2>
      <p>
        メディアタブは最初に一部の画像しか表示されないので、
        スクロールして追加読み込みする必要がある。
        自動スクロールで全画像を読み込んでから取得するスクリプト：
      </p>
      <CodeBlock code={autoScrollScript} language="javascript" />
      <p>
        このスクリプトは自動的にスクロールして画像を読み込み、
        最後まで到達したらURLを取得する。
        大量の画像がある場合は時間がかかるので注意。
      </p>

      <h2>取得したURLをダウンロードする方法</h2>
      
      <h3>方法1: ブラウザ拡張機能を使う</h3>
      <p>
        取得したURLをテキストファイルに保存して、以下のような拡張機能で一括ダウンロード：
      </p>
      <ul>
        <li><strong>DownThemAll!</strong> (Firefox)</li>
        <li><strong>Turbo Download Manager</strong> (Chrome, Firefox)</li>
        <li><strong>Image Downloader</strong> (Chrome)</li>
      </ul>

      <h3>方法2: スクリプトで順次ダウンロード</h3>
      <p>
        開発者コンソールから直接ダウンロードする方法（Chrome推奨）：
      </p>
      <CodeBlock code={downloadScript} language="javascript" />
      <p>
        <strong>注意</strong>: ブラウザによっては大量のダウンロードがブロックされる場合がある。
        その場合、ブラウザの設定で「複数ファイルのダウンロードを許可」する必要がある。
      </p>

      <h3>方法3: コマンドラインツール（上級者向け）</h3>
      <p>
        <code>wget</code> や <code>curl</code> を使ってターミナルからダウンロード：
      </p>
      <CodeBlock code="wget -i urls.txt" language="bash" />
      <p>
        <code>urls.txt</code> には取得したURLを1行1URLで保存しておく。
      </p>

      <h2>注意事項</h2>
      <ul>
        <li>大量の画像を一気にダウンロードすると、Twitter側のレート制限に引っかかる可能性がある</li>
        <li>他人の画像をダウンロードする場合、著作権に注意</li>
        <li>ブラウザによっては自動ダウンロードがブロックされる場合がある</li>
        <li>スクリプトはTwitterの仕様変更で動かなくなる可能性がある</li>
      </ul>

      <h2>関連記事</h2>
      <ul>
        <li><a href="/tips/twitter-image-original-quality">X(Twitter)の画像をオリジナル画質で保存する方法</a></li>
        <li><a href="/tips/twitter-image-only-filter">X(Twitter)のタイムラインを「画像のみ」表示に切り替える</a></li>
      </ul>
    </article>
  </main>
</Layout>

<style>
  main {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
    line-height: 1.7;
  }

  .article-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #667eea;
    text-decoration: none;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .article-body h2 {
    font-size: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: #333;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 0.25rem;
  }

  .article-body h3 {
    font-size: 1.2rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    color: #444;
  }

  .article-body p, .article-body ul, .article-body ol {
    margin-bottom: 1rem;
    color: #444;
  }

  .article-body li {
    margin-bottom: 0.25rem;
  }

  .article-body ul, .article-body ol {
    padding-left: 2rem;
  }

  .article-body code {
    background: #f4f4f4;
    color: #d63384;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .article-body a {
    color: #667eea;
    text-decoration: none;
  }

  .article-body a:hover {
    text-decoration: underline;
  }

  .article-body strong {
    font-weight: 600;
    color: #333;
  }

  pre {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 1rem 1.25rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1rem 0;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  pre code {
    background: none;
    color: inherit;
    padding: 0;
  }

  .note-box {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 1rem;
    margin: 1.5rem 0;
    border-radius: 4px;
  }

  .note-box strong {
    display: block;
    margin-bottom: 0.5rem;
    color: #856404;
  }

  .note-box p {
    margin: 0.5rem 0;
    color: #856404;
  }

  .note-box ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
    color: #856404;
  }

  .note-box li {
    margin: 0.25rem 0;
  }
</style>
